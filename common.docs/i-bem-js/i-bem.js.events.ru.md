<a name="events"></a>
## События

В `i-bem.js` поддерживается два вида событий:

* **DOM-событие** — jQuery-событие на DOM-узле, связанном с
блоком. Отражает взаимодействие пользователя с интерфейсом (клик,
наведение мыши, ввод текста и т.п.). DOM-событие обычно обрабатывает
тот экземпляр блока, на DOM-узле которого оно возникло.
* **БЭМ-событие** — собственное событие, генерируемое
блоком. Позволяет организовать API для
[взаимодействия с блоком](#ibc). БЭМ-событие обычно обрабатывает
экземпляр блока, отслеживающий состояние других блоков, на которых
генерируются события.

DOM-события следует использовать только во *внутренних* процедурах блока. Для
взаимодействия блока с *внешней* средой (другими блоками), предназначены БЭМ-события.

<a name="delegated-events"></a>
### Делегирование событий

Обработка БЭМ- и DOM-событий может быть **делегирована** контейнеру
(всему документу или конкретному DOM-узлу). В этом случае контейнер
служит точкой обработки событий, возникающих на любом из его
дочерних узлов, даже если в момент подписки на события
некоторых из дочерних узлов еще не существовало.

Блок меню может содержать вложенные блоки (или элементы, в
зависимости от конкретной реализации блока): например, пункты меню. Обработку
кликов на пунктах меню имеет смысл делегировать самому блоку
меню. Это, во-первых, позволяет сэкономить затраты ресурсов на
подписку на события (дешевле подписаться на одно событие контейнера,
чем на много событий элементов). Во-вторых, дает возможность добавлять и удалять пункты меню, не подписываясь на события добавленных пунктов и не отписываясь от событий удаленных.

Возможно делегировать как БЭМ, так и DOM-события.

<a name="dom-events"></a>
### DOM-события

Работа с DOM-событиями в `i-bem.js` полностью реализована средствами фреймворка jQuery.

#### Подписка на DOM-событие

У объекта экземпляра блока зарезервирован набор методов для подписки на DOM-события:

* `bindToDomElem(domElem, event, [data], fn)` – на события произвольного DOM-узла `domElem`.
* `bindToDoc(event, [data], fn)` – на события DOM-узла `document`.
* `bindToWin(event, [data], fn)` – на события DOM-узла `window`.
* `bindTo([elem], event, handler)` — на события основного DOM-узла блока и DOM-узлов его элементов.

**Пример:** В момент [инициализации экземпляра блока](#init)
`my-block` выполняется подписка на событие `click`, при наступлении
которого блок выставляет себе [модификатор](#modifier) `size` в
значение `big`.

```js
BEMDOM.decl('my-block', {
    onSetMod : {
        'js' : {
            'inited': function() {
                this.bindTo('click', function(e) {
                    var domElem = $(e.currentTarget); // DOM-элемент, на котором слушается событие
                                                      // в данном случае то же, что this.domElem
                    this.setMod('size', 'big');
                });
            }
        }
    }
});
```


**Пример:** При [инициализации экземпляра блока](#init) `my-form` выполняется
подписка на событие `click` элемента `submit`, при наступлении
которого будет вызван метод экземпляра блока `_onSubmit`.

```js
BEMDOM.decl('my-block', {
    onSetMod : {
        'js' : {
            'inited': function() {
                this.bindTo('submit', 'click', function(e) {
                    var domElem = $(e.currentTarget); // DOM-элемент, на котором слушается событие
                                                      // в данном случае то же, что this.elem('submit')
                    this._onSubmit();
                });
            }
        }
    },

    _onSubmit : function() { /* ... */ }
});
```


**NB** Функция-обработчик выполняется в контексте того экземпляра
блока, в котором возникло событие.

#### Удаление подписки на DOM-событие

Удаление подписки на DOM-события выполняется автоматически при уничтожении экземпляра блока. Тем не менее, у объекта экземпляра блока зарезервирован набор методов для удаления подписки вручную во время работы блока:

* `unbindFromDomElem(domElem, event, [fn])` – от событий произвольного DOM-узла `domElem`.
* `unbindFromDoc(event, [fn])` – от событий DOM-узла `document`.
* `unbindFromWin(event, [fn])` – от событий DOM-узла `window`.
* `unbindFrom([elem], event, [handler])` — от событий основного DOM-узла блока и DOM-узлов его элементов.

Если при вызове одного из методов не указана функция-обработчик, будут удалены все обработчики, установленные на DOM-узле для этого события.

```js
_stopKeysListening : function() { 
    this.unbindFromDoc('keydown'); // удаляем все обработчики события 'keydown' у DOM-узла document
} 
```


#### Объект DOM-события
Первым аргументом функция-обработчик получает jQuery-объект DOM-события — [`{jQuery.Event}`](https://api.jquery.com/category/events/event-object/).

Это позволяет использовать методы объекта такие, как `stopPropogation` и `preventDefault`, для управления распространением события и его обработкой браузером.

```js
BEMDOM.decl('my-block', {
    onSetMod : {
        'js' : {
            'inited': function() {
                this.bindTo('click', function(e) {
                    e.stopPropogation(); // останавливаем всплытие события
                    this._onSubmit();
                });
            }
        }
    },

    _onSubmit : function() {
    /* ... */
    }
});
```


Вместо вызова `stopPropogation()` можно вернуть `false` из функции-обработчика.

```js
this.bindTo('click', function(e) {
    this._onSubmit();
    return false
});
```


Если DOM-событие было сгенерировано вручную, все параметры, переданные функции `trigger` при создании события, будут переданы функции-обработчику в том же порядке после объекта события.

**N.B.** Параметры окружения и поведение функции-обработчика события идентичны [функции-обработчику](http://api.jquery.com/on/#event-handler) jQuery.

<a name="dom-events-delegated"></a>
#### Делегирование DOM-событий

Делегировать обработку DOM-событий рекомендуется с помощью метода `liveBindTo([elem], event, handler)`. В статических методах декларации блока зарезервированно свойство `live` для подписки на делегированные DOM-события.

**Пример:** Все экземпляры блока `menu` подписываются на делегированное DOM-событие `click` своих элементов `item`. Метод `_onItemClick` экземпляра блока `menu` будет выполняться при клике на любой элемент `item` в меню. Не важно, существовал ли этот элемент в момент инициализации экземпляра.

```js
BEMDOM.decl('menu', {
    _onItemClick : function(e) {
        var clickedItem = $(e.target).closest(this.buildSelector('item')); // элемент 'item' блока 'menu', на котором слушается DOM-событие 'click'
    }
}, {
    live : function() {
        this.liveBindTo('item', 'click', function(e) {
            this._onItemClick(e);
        });
    }
});
```


Если в декларации блока задано свойство `live`, инициализация экземпляров блока будет *отложена* до момента, когда экземпляр блока потребуется в работе ([ленивая инициализация](#init-live)). Таким моментом может стать DOM-событие на экземпляре блока, на которое выполнена делегированная подписка, или обращение к экземпляру блока [из другого блока](#ibc).

**NB** Функция-обработчик выполняется в контексте ближайшего блока данного типа на пути всплывания DOM-события (снизу вверх по DOM-дереву).

Чтобы воспользоваться делегированными событиями в блоке не откладывая инициализацию (экземпляры блока должны быть инициализированы по `domReady`), следует вернуть `false`:

```js
modules.define('my-block', ['i-bem__dom'], function(provide, BEMDOM) {

provide(BEMDOM.decl(this.name,
    {
        onSetMod: {
            'js': {
                'inited': function() { /* ... */ } // будет выполнена по наступлении domReady
            }
        },

        _onClick: function() { /* ... */ } // будет выполняться каждый
                                           // раз при наступлении DOM-события 'click'
    },
    {
        live: function() {
            this.liveBindTo('click', function() { this._onClick() });
            return false; // экземпляры блоков будут инициализированы автоматически
        }
    }
));

});
```


**Удаление подписки** на делегированные DOM-события никогда не выполняется автоматически. Для ее удаления используйте метод `liveUnbindFrom([elem], event, [handler])`.

```js
BEMDOM.decl('menu', {
    onSetMod : {
        'js' : {
            '' : function() {
                this.liveUnbindFrom('item', 'click', function(e) { this._onItemClick(e) });
            }
        }
    }
});
```


<a name="bem-events"></a>
### БЭМ-события

В отличие от DOM-событий, БЭМ-события генерируются не на DOM-элементах, а на **экземплярах блоков**. Элементы блоков не могут генерировать БЭМ-события.

<a name="bem-events-subscribe"></a>
#### Генерация БЭМ-события

Чтобы сгенерировать БЭМ-событие, используется метод экземпляра блока
`emit(event, [data])`.

Взаимодействие пользователя с элементом управления блока (DOM-событие) можно преобразовать в БЭМ-событие на блоке. Например, при клике по кнопке `submit` (DOM-событие `click`) **БЭМ-событие** `click` генерируется только в том случае, если у блока в этот момент не выставлен модификатор `disabled`:

```js
BEMDOM.decl('submit', {
    onSetMod: {
        'js': {
            'inited': function() {
                this.bindTo('click', this._onClick); // подписка на DOM-событие "click"
            }
        }
    },

    _onClick: function() {
        if(!this.hasMod('disabled')) {
            this.emit('click'); // создание БЭМ-события "click"
        }
    }
});
```


Вторым аргументом методу можно передать произвольные данные, которые будут доступны как второй аргумент функции-обработчика.

<a name="bem-events-subscribe"></a>
#### Подписка на БЭМ-события

Для подписки на БЭМ-события экземпляров блоков используются методы
экземпляра блока `on(event, [data], handler, [handlerCtx])`.

**Пример:** В момент инициализации HTML-формы (экземпляра блока `my-form`) выполняется поиск вложенной в форму кнопки `submit` и подписка на ее БЭМ-событие `click`. В результате при нажатии на кнопку (экземпляр блока `submit`) будет выполнен метод `_onSubmit` формы (экземпляр блока `my-form`).

```js
BEMDOM.decl('my-form', {
    onSetMod: {
        'js': {
            'inited': function() {
                this.findBlockInside('submit').on(
                    'click', // имя БЭМ-события
                    this._onSubmit, // метод экземпляра блока my-form
                    this); // контекст для выполнения _onSubmit — блок my-form
            }
        }
    },

    _onSubmit: function() { /* ... */ }
});
```


**NB** Если не указывать последний параметр метода `on` —
`[handlerCtx]`, контекстом для выполнения функции-обработчика будет
тот блок, в котором возникло БЭМ-событие (в примере выше это блок
`submit`).

<a name="bem-events-unsubscribe"></a>
#### Удаление подписки на БЭМ-события

Удаление подписки на БЭМ-события выполняется автоматически при уничтожении экземпляра блока. Для ручного удаления подписки, используйте метод экземпляра блока
`un(event, [handler], [handlerCtx])`.

<a name="bem-events-modchange"></a>
#### События при изменении модификаторов

Для подписки на БЭМ-события при изменении модификатора блока или элемента используется метод экземпляра блока `on`. Метод принимает аргументами:

* объект, описывающий модификатор, на который производится подписка;
* функцию обратного вызова, выполняющуюся при установке соответствующего модификатора.

Объект, описывающий модификатор, может содержать следующие зарезервированные свойства:

* `modName` `{String}` – имя модификатора. Обязательное свойство.
* `modVal` `{String}` – значение модификатора. Обязательное свойство. Со значением `*` производится подписка на установку модификатора в **любое** значение. Со значением `''` – на **удаление** модификатора. Подробнее смотрите в разделе [триггеры на установку модификаторов](#mods-api-trigger).
* `elem` `{String}` – имя элемента (для модификаторов элементов).

**Пример:** В момент инициализации блока `monitor` выполнятся подписка на:

* установку модификатора `m1` в любое значение;
```js
BEMDOM.decl('monitor', {
    onSetMod: {
        'js': {
            'inited': function() {
              block1.on({ modName : 'm1', modVal : '*' }, function() {});
            }
        }
    },
});
```


* установку модификатора `m1` в значение `v1`;
```js
block1.on({ modName : 'm1', modVal : 'v1' }, function() {});
```


* удаление модификатора `m1`;
```js
block1.on({ modName : 'm1', modVal : '' }, function() {});
```


* удаление модификатора `m1` у элемента `e1`;
```js
block1.on({ elem : 'e1', modName : 'm1', modVal : '' }, function() {});
```


**NB** В целях оптимизации производительности БЭМ-события при изменении модификаторов генерируются только, если для них есть подписчики.


<a name="bem-events-delegated"></a>
#### Делегирование БЭМ-событий

Делегирование БЭМ-событий означает, что блок подписывается на определенное БЭМ-событие **всех экземпляров** блока с заданным именем **в пределах заданного контекста**. Подписка на делегированные БЭМ-события выполняется с помощью статического метода `BEMDOM.on([ctx], event, [data], handler, [handlerCtx])`.

Параметры:

* `{jQuery} [ctx]` — DOM-узел, в пределах которого отслеживаются БЭМ-события (контейнер). Если не указан, в качестве контейнера используется весь документ.
* `{String} event` — имя БЭМ-события.
* `{Object} [data]` — произвольные данные, передаваемые функции-обработчику.
* `{Function} handler` — функция-обработчик события.
* `{Object} [handlerCtx]` — контекст функции-обработчика события. Если отсутствует, функция-обработчик будет выполняться в контексте экземпляра блока в котором произошло событие.

**Пример:** При инициализации экземпляров блока `menu` выполняется подписка на БЭМ-событие `click` всех ссылок (экземпляров блока `link`) в пределах DOM-узла блока (`this.domElem`). В качестве контекста функции-обработчика передается текущий экземпляр блока.
При [уничтожении экземпляров блока](#destruct) `menu` с помощью статического метода `un([ctx], event, [handler], [handlerCtx])` производится **удаление подписки** на делегированные
БЭМ-события.

```js
BEMDOM.decl('menu', {
    onSetMod : {
        'js' : {
            'inited' : function() {
                BEMDOM.blocks['link'].on( // подписка на БЭМ-событие
                    this.domElem, // контейнер — DOM-узел экземпляра блока menu
                    'click', // БЭМ-событие
                    this._onLinkClick, // обработчик
                    this); // контекст обработчика — экземпляр блока menu
            },

            '' : function() {
                BEMDOM.blocks['link'].un( // удаление подписки на БЭМ-событие
                    this.domElem,
                    'click',
                    this._onLinkClick,
                    this);
            }
        }
    },

    _onLinkClick : function(e) {
        var clickedLink = e.target; // экземпляр блока 'link', на котором произошло БЭМ-событие 'click'
    }
});
```


Делегировать можно любые БЭМ-событий, в том числе и события при изменении модификаторов.

**NB** **Удаление подписки** на делегированные БЭМ-события никогда не происходит автоматически. Всегда следует явно удалять подписку при
помощи статического метода блока `un([ctx], event, [handler], [handlerCtx])`.

<a name="api"></a>
### Объект БЭМ-события

В качестве параметра функции-обработчику передается объект, описывающий БЭМ-событие. Класс объекта БЭМ-события `events.Event` определен в [ym][]-модуле [`events`](https://github.com/bem/bem-core/blob/v2/common.blocks/events/events.vanilla.js) библиотеки bem-core. Содержит поля:

* `target` — экземпляр блока, в котором произошло БЭМ-событие.
* `data` — произвольные дополнительные данные, переданные как аргумент `data` при подписке на БЭМ-событие.
* `result` — последнее значение, возвращенное обработчиком данного события. Аналогично [jQuery.Event.result](https://api.jquery.com/event.result/).
* `type` — тип события. Аналогично [jQuery.Event.type](https://api.jquery.com/event.type/).

Подробнее о свойствах и методах объекта БЭМ-события читайте в [документации блока event](https://github.com/bem/bem-core/blob/v2/common.blocks/events/events.ru.md).
